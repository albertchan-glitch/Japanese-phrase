<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—¥è¯­æ­é…è”æƒ³å®¶</title>
    <style>
        :root { --primary: #ff5bec; --bg: #F5F5F7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; color: #1d1d1f; display: flex; justify-content: center; }

        .app-container { width: 90%; max-width: 500px; padding-top: 10vh; }

        /* æœç´¢æ¡† (å›¾ç‰‡åŒæ¬¾è®¾è®¡) */
        .search-box { position: relative; margin-bottom: 50px; }
        #keywordInput { 
            width: 100%; padding: 18px 25px; border-radius: 40px; border: none; 
            background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.05); font-size: 17px; outline: none; box-sizing: border-box;
        }
        .search-btn { 
            position: absolute; right: 8px; top: 7px; background: var(--primary); 
            color: white; border: none; padding: 11px 24px; border-radius: 30px; font-weight: 600; cursor: pointer; 
        }

        /* ç¬¬ä¸€é¡µï¼šå¤§æ¿å—æŒ‰é’® */
        .scene-entry { 
            background: white; padding: 25px; border-radius: 20px; margin-bottom: 20px;
            display: flex; align-items: center; cursor: pointer; transition: 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }
        .scene-entry:active { transform: scale(0.98); background: #f9f9f9; }
        .scene-entry .icon { font-size: 30px; margin-right: 20px; }
        .scene-entry .text { font-size: 18px; font-weight: 600; }

        /* ç¬¬äºŒé¡µï¼šåŠ¨ä½œåˆ—è¡¨ */
        .action-list { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .action-item { 
            background: white; padding: 18px 25px; border-radius: 15px; 
            font-size: 16px; font-weight: 500; cursor: pointer; display: flex; justify-content: space-between;
        }

        /* ç»“æœå¡ç‰‡ */
        /* è§£å†³æ’­æ”¾å›¾æ ‡é¼ æ ‡æ˜¾ç¤ºä¸ºå·¥å­—å‹çš„é—®é¢˜ */
.phrase-card div:last-child {
    cursor: pointer !important;  /* å¼ºåˆ¶å˜å›å°æ‰‹ */
    user-select: none;           /* é˜²æ­¢ç‚¹å‡»æ—¶é€‰ä¸­ç¬¦å· */
}
        .phrase-card { 
            background: white; padding: 20px; border-radius: 20px; margin-bottom: 12px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); animation: fadeIn 0.4s ease;
        }

        .back-btn { color: var(--primary); cursor: pointer; font-size: 14px; margin-bottom: 20px; display: inline-block; font-weight: 600; }
        .hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .error-msg { color: #FF3B30; background: #FFF2F2; padding: 15px; border-radius: 10px; font-size: 14px; margin-top: 20px; line-height: 1.4; }
    </style>
</head>
<body>

<div class="app-container">
    <h1 style="text-align:center; font-size:26px; margin-bottom:40px;">æ—¥è¯­<span style="color:var(--primary)">æ­é…</span>è”æƒ³å®¶</h1>

    <div class="search-box">
        <input type="text" id="keywordInput" placeholder="è¾“å…¥å…³é”®è¯ï¼Œå¦‚ï¼šæ­¯ã€ä¼šè­°..." onkeypress="if(event.keyCode==13) doActionSearch()">
        <button class="search-btn" onclick="doActionSearch()">è”æƒ³</button>
    </div>

    <div id="page-1">
        <div class="scene-entry" onclick="showActions('æ—¥å¸¸ç”Ÿæ´»')">
            <span class="icon">ğŸ </span><span class="text">æ—¥å¸¸ç”Ÿæ´»</span>
        </div>
        <div class="scene-entry" onclick="showActions('å·¥ä½œåœºåˆ')">
            <span class="icon">ğŸ’¼</span><span class="text">å·¥ä½œåœºåˆ</span>
        </div>
        <div class="scene-entry" onclick="showActions('æ—…è¡Œè¿œè¶³')">
            <span class="icon">âœˆï¸</span><span class="text">æ—…è¡Œè¿œè¶³</span>
        </div>
    </div>

    <div id="page-2" class="hidden">
        <span class="back-btn" onclick="toPage(1)">â† è¿”å›ä¸»é¡µ</span>
        <h2 id="scene-title" style="margin-bottom:20px;"></h2>
        <div id="action-container" class="action-list"></div>
    </div>

    <div id="page-3" class="hidden">
        <span class="back-btn" onclick="toPage(2)">â† è¿”å›åˆ—è¡¨</span>
        <div id="result-list"></div>
    </div>
</div>

<script>
    const API_KEY = 'sk-7d63bfe034c8430eb76bac0f9e00ce5b'; // è¯·åŠ¡å¿…æ£€æŸ¥Keyæ˜¯å¦æ­£ç¡®
    const API_URL = 'https://api.deepseek.com/chat/completions';

    const SCENE_DATA = {
        'æ—¥å¸¸ç”Ÿæ´»': ['èµ·åºŠ', 'æ¢³å¤´', 'ç©¿è¡£æœ', 'åˆ·ç‰™', 'æ´—è„¸', 'åŒ–å¦†', 'æ´—æ¾¡', 'åšé¥­', 'æ•£æ­¥', 'ç¡è§‰'],
        'å·¥ä½œåœºåˆ': ['å¼€ä¼š', 'å‡ºå·®', 'å†™é‚®ä»¶', 'æ‰“ç”µè¯', 'æ±‡æŠ¥', 'åŠ ç­', 'é¢è¯•', 'è¯·å‡', 'æ¥å¾…', 'è¾èŒ'],
        'æ—…è¡Œè¿œè¶³': ['ç™»æœº', 'åè½¦', 'é‡é¤', 'èµèŠ±', 'æ‹ç…§', 'é¢„è®¢', 'é—®è·¯', 'è´­ç‰©', 'æ¢é’±', 'é€€æˆ¿']
    };

    function toPage(num) {
        document.querySelectorAll('[id^="page-"]').forEach(p => p.classList.add('hidden'));
        document.getElementById(`page-${num}`).classList.remove('hidden');
    }

    function showActions(scene) {
        const container = document.getElementById('action-container');
        document.getElementById('scene-title').innerText = scene;
        container.innerHTML = '';
        SCENE_DATA[scene].forEach(act => {
            const div = document.createElement('div');
            div.className = 'action-item';
            div.innerHTML = `<span>${act}</span><span>â†’</span>`;
            div.onclick = () => doActionSearch(act);
            container.appendChild(div);
        });
        toPage(2);
    }

        async function doActionSearch(manualWord = null) {
        const word = manualWord || document.getElementById('keywordInput').value.trim();
        if(!word) return;

        toPage(3);
        const list = document.getElementById('result-list');
        list.innerHTML = '<div style="text-align:center; padding:50px; color:#8e8e93;">AI æ­£åœ¨åˆ†æåœ°é“æ­é…...</div>';

        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        {
                            role: "system", 
                            // æ ¸å¿ƒä¿®æ”¹ï¼šå¼ºåˆ¶ AI è¿”å›å¸¦ ruby æ ‡ç­¾çš„å†…å®¹
                            content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ—¥è¯­è€å¸ˆã€‚è¿”å›5ä¸ªæœ€åœ°é“çš„çŸ­è¯­æ­é…ï¼ˆå«åŠ©è¯ï¼‰ã€‚è¦æ±‚ï¼š1.æ±‰å­—å¿…é¡»ä½¿ç”¨HTMLçš„rubyæ ‡ç­¾æ ‡æ³¨å¹³å‡åã€‚2.ä¸¥æ ¼æŒ‰JSONæ•°ç»„æ ¼å¼è¿”å›ï¼š[{\"jp\":\"<ruby>æ±‰<rt>ã‹ã‚“</rt>å­—<rt>ã˜</rt></ruby>\",\"zh\":\"ç¿»è¯‘\"}]ã€‚"
                        }, 
                        {role: "user", content: word}
                    ]
                })
            });

            if (res.status === 401) {
                list.innerHTML = `<div class="error-msg">âš  <strong>API Key é”™è¯¯ (401)</strong><br>è¯·æ£€æŸ¥ Key æ˜¯å¦æœ‰æ•ˆã€‚</div>`;
                return;
            }

            const data = await res.json();
            // è¿™é‡Œè·å–çš„å†…å®¹å·²ç»è‡ªå¸¦ <ruby> æ ‡ç­¾äº†
            const phrases = JSON.parse(data.choices[0].message.content);
            
            list.innerHTML = '';
            phrases.forEach(p => {
    const card = document.createElement('div');
    card.className = 'phrase-card';
    
    // ã€ä¿®æ”¹ç‚¹ 1ã€‘ï¼šè¿™é‡Œæ˜¯æ ¸å¿ƒï¼
    // é€»è¾‘ï¼šå…ˆæŠŠ <rt>å‡å</rt> å…¨éƒ¨åˆ æ‰ï¼Œå†æŠŠå‰©ä¸‹çš„ <ruby> ç­‰æ ‡ç­¾åˆ æ‰
    // è¿™æ ·å°±åªå‰©ä¸‹äº†ï¼šæ±‰å­— + åŠ©è¯
    const pureText = p.jp.replace(/<rt>.*?<\/rt>/g, '').replace(/<[^>]+>/g, '');
    
    card.onclick = () => speak(pureText);

    card.innerHTML = `
        <div>
            <div style="font-size:20px; font-weight:600; line-height:1.8;">${p.jp}</div>
            <div style="color:#8e8e93; font-size:14px; margin-top:4px;">${p.zh}</div>
        </div>
        <div style="color:var(--primary); cursor:pointer;">â–¶</div>
    `;
    list.appendChild(card);
});
        } catch (e) {
            list.innerHTML = '<div class="error-msg">è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿ AI è¿”å›äº†æ­£ç¡®çš„æ ¼å¼ã€‚</div>';
        }
    }

    function speak(text) {
    // 1. å½»åº•é”€æ¯æ—§éŸ³é¢‘ï¼Œé˜²æ­¢å®‰å“æµè§ˆå™¨â€œå¡æ­»â€
    if (window.currentAudio) {
        window.currentAudio.pause();
        window.currentAudio.src = "";
        window.currentAudio.load();
    }

    // 2. æå–çº¯å‡€æ—¥è¯­æ–‡æœ¬ï¼ˆå»æ‰ ruby æ³¨éŸ³ï¼‰
    let div = document.createElement("div");
    div.innerHTML = text;
    const rts = div.querySelectorAll('rt');
    rts.forEach(rt => rt.remove());
    let pureText = div.innerText || div.textContent;
    
    // æ¸…æ´—ï¼šå»æ‰ç©ºæ ¼ã€å›è½¦ï¼Œé™åˆ¶é•¿åº¦é˜²æŠ¥é”™
    pureText = pureText.replace(/\s+/g, "").trim().substring(0, 200);
    if (!pureText) return;

    // 3. å‡†å¤‡ä¸¤ä¸ªäº‘ç«¯æ¥å£
    const baiduUrl = `https://fanyi.baidu.com/getvoice?lan=jp&pydown=0&tpl=6&text=${encodeURIComponent(pureText)}`;
    const youdaoUrl = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(pureText)}&le=jap`;

    const audio = new Audio();
    window.currentAudio = audio;

    // --- ç­–ç•¥å¼€å§‹ ---
    
    // ç¬¬ä¸€æ­¥ï¼šå°è¯•ç™¾åº¦
    audio.src = baiduUrl;
    audio.play().catch(() => {
        console.warn("ç™¾åº¦æ¥å£å¤±è´¥ï¼Œå°è¯•æœ‰é“...");
        
        // ç¬¬äºŒæ­¥ï¼šå°è¯•æœ‰é“
        audio.src = youdaoUrl;
        audio.play().catch(() => {
            console.warn("äº‘ç«¯æ¥å£å…¨éƒ¨å¤±æ•ˆï¼Œå¯åŠ¨æœ¬åœ°å…œåº•...");
            
            // ç¬¬ä¸‰æ­¥ï¼šæœ¬åœ°å…œåº•ï¼ˆå¼ºåˆ¶æŒ‡å®šæ—¥è¯­ï¼‰
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(pureText);
            msg.lang = 'ja-JP'; // å¼ºåˆ¶è¦æ±‚æ—¥è¯­ç¯å¢ƒ
            
            // å°è¯•åœ¨æœ¬åœ°è¯­éŸ³åŒ…é‡Œæ‰¾æ—¥è¯­æ’­éŸ³å‘˜
            const voices = window.speechSynthesis.getVoices();
            const jaVoice = voices.find(v => v.lang.includes('ja') || v.name.includes('Japanese'));
            if (jaVoice) msg.voice = jaVoice;
            
            window.speechSynthesis.speak(msg);
        });
    });
}
</script>
</body>
</html>
