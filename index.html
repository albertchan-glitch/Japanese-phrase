<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—¥è¯­æ­é…è”æƒ³å®¶</title>
    <style>
        :root { --primary: #ff5bec; --bg: #F5F5F7; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; color: #1d1d1f; display: flex; justify-content: center; }
        .app-container { width: 90%; max-width: 500px; padding-top: 10vh; }
        .search-box { position: relative; margin-bottom: 50px; }
        #keywordInput { width: 100%; padding: 18px 25px; border-radius: 40px; border: none; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.05); font-size: 17px; outline: none; box-sizing: border-box; }
        .search-btn { position: absolute; right: 8px; top: 7px; background: var(--primary); color: white; border: none; padding: 11px 24px; border-radius: 30px; font-weight: 600; cursor: pointer; }
        .scene-entry { background: white; padding: 25px; border-radius: 20px; margin-bottom: 20px; display: flex; align-items: center; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.03); -webkit-tap-highlight-color: transparent; }
        .scene-entry:active { background: #f0f0f0; }
        .scene-entry .icon { font-size: 30px; margin-right: 20px; }
        .scene-entry .text { font-size: 18px; font-weight: 600; }
        .action-list { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .action-item { background: white; padding: 18px 25px; border-radius: 15px; font-size: 16px; font-weight: 500; cursor: pointer; display: flex; justify-content: space-between; }
        .phrase-card { background: white; padding: 20px; border-radius: 20px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .back-btn { color: var(--primary); cursor: pointer; font-size: 14px; margin-bottom: 20px; display: inline-block; font-weight: 600; padding: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="app-container">
    <h1 style="text-align:center; font-size:26px; margin-bottom:40px;">æ—¥è¯­æ­é…è”æƒ³å®¶</h1>
    
    <div class="search-box">
        <input type="text" id="keywordInput" placeholder="è¾“å…¥å…³é”®è¯...">
        <button class="search-btn" onclick="handleManualSearch()">è”æƒ³</button>
    </div>

    <div id="page-1">
        <div class="scene-entry" onclick="handleSceneClick('æ—¥å¸¸ç”Ÿæ´»')">
            <span class="icon">ğŸ </span><span class="text">æ—¥å¸¸ç”Ÿæ´»</span>
        </div>
        <div class="scene-entry" onclick="handleSceneClick('å·¥ä½œåœºåˆ')">
            <span class="icon">ğŸ’¼</span><span class="text">å·¥ä½œåœºåˆ</span>
        </div>
        <div class="scene-entry" onclick="handleSceneClick('æ—…è¡Œè¿œè¶³')">
            <span class="icon">âœˆï¸</span><span class="text">æ—…è¡Œè¿œè¶³</span>
        </div>
    </div>

    <div id="page-2" class="hidden">
        <div class="back-btn" onclick="goToPage(1)">â† è¿”å›ä¸»é¡µ</div>
        <h2 id="scene-title"></h2>
        <div id="action-container" class="action-list"></div>
    </div>

    <div id="page-3" class="hidden">
        <div class="back-btn" onclick="goToPage(2)">â† è¿”å›åˆ—è¡¨</div>
        <div id="result-list"></div>
    </div>
</div>

<script>
    // ä½¿ç”¨ var ç¡®ä¿æœ€å¼ºå…¼å®¹æ€§
    var API_KEY = 'sk-7d63bfe034c8430eb76bac0f9e00ce5b';
    var API_URL = 'https://api.deepseek.com/chat/completions';
    var audioObj = null;

    function goToPage(num) {
        document.getElementById('page-1').classList.add('hidden');
        document.getElementById('page-2').classList.add('hidden');
        document.getElementById('page-3').classList.add('hidden');
        document.getElementById('page-' + num).classList.remove('hidden');
        window.scrollTo(0,0);
    }

    function handleSceneClick(sceneName) {
        var data = {
            'æ—¥å¸¸ç”Ÿæ´»': ['èµ·åºŠ', 'æ¢³å¤´', 'ç©¿è¡£æœ', 'åˆ·ç‰™', 'æ´—è„¸', 'åŒ–å¦†', 'æ´—æ¾¡', 'åšé¥­', 'æ•£æ­¥', 'ç¡è§‰'],
            'å·¥ä½œåœºåˆ': ['å¼€ä¼š', 'å‡ºå·®', 'å†™é‚®ä»¶', 'æ‰“ç”µè¯', 'æ±‡æŠ¥', 'åŠ ç­', 'é¢è¯•', 'è¯·å‡', 'æ¥å¾…', 'è¾èŒ'],
            'æ—…è¡Œè¿œè¶³': ['ç™»æœº', 'åè½¦', 'é‡é¤', 'èµèŠ±', 'æ‹ç…§', 'é¢„è®¢', 'é—®è·¯', 'è´­ç‰©', 'æ¢é’±', 'é€€æˆ¿']
        };
        var actions = data[sceneName];
        var container = document.getElementById('action-container');
        document.getElementById('scene-title').innerText = sceneName;
        container.innerHTML = '';
        
        for (var i = 0; i < actions.length; i++) {
            var act = actions[i];
            var item = document.createElement('div');
            item.className = 'action-item';
            item.innerHTML = '<span>' + act + '</span><span>â†’</span>';
            // ç§»åŠ¨ç«¯ä½¿ç”¨è¿™ç§ç»‘å®šæ–¹å¼æœ€ç¨³
            item.setAttribute('onclick', "doFinalSearch('" + act + "')");
            container.appendChild(item);
        }
        goToPage(2);
    }

    function handleManualSearch() {
        var val = document.getElementById('keywordInput').value;
        if(val) doFinalSearch(val);
    }

    function doFinalSearch(word) {
        goToPage(3);
        var list = document.getElementById('result-list');
        list.innerHTML = '<div style="text-align:center; padding:50px; color:#999;">AI æ­£åœ¨è”æƒ³...</div>';

        // æ”¹ç”¨ fetch çš„æ™®é€šå†™æ³•ï¼Œä¸ä½¿ç”¨ async/await
        fetch(API_URL, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + API_KEY 
            },
            body: JSON.stringify({
                model: "deepseek-chat",
                messages: [
                    {role: "system", content: "è¿”å›5ä¸ªæ—¥è¯­çŸ­è¯­JSONæ•°ç»„:[{\"jp\":\"<ruby>æ±‰<rt>ã‹ã‚“</rt></ruby>\",\"zh\":\"ç¿»è¯‘\"}]"},
                    {role: "user", content: word}
                ]
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(resData) {
            var raw = resData.choices[0].message.content.replace(/```json|```/g, '');
            var phrases = JSON.parse(raw);
            list.innerHTML = '';
            
            for (var j = 0; j < phrases.length; j++) {
                var p = phrases[j];
                var card = document.createElement('div');
                card.className = 'phrase-card';
                card.innerHTML = '<div><div style="font-size:18px; font-weight:bold;">'+p.jp+'</div><div style="color:#666; font-size:14px;">'+p.zh+'</div></div><div style="color:#ff5bec; font-size:24px;">â–¶</div>';
                
                // æå–å‘éŸ³æ–‡æœ¬
                var tmp = document.createElement('div');
                tmp.innerHTML = p.jp;
                var rts = tmp.getElementsByTagName('rt');
                while(rts.length > 0) { rts[0].parentNode.removeChild(rts[0]); }
                var speechText = tmp.innerText || tmp.textContent;
                
                card.setAttribute('onclick', "playJap('" + speechText.replace(/'/g, "\\'") + "')");
                list.appendChild(card);
            }
        })
        .catch(function(err) {
            list.innerHTML = '<div style="color:red; padding:20px;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚</div>';
               <div class="scene-entry" onclick="showActions('æ—¥å¸¸ç”Ÿæ´»')">
            <span class="icon">ğŸ </span><span class="text">æ—¥å¸¸ç”Ÿæ´»</span>
        </div>
        <div class="scene-entry" onclick="showActions('å·¥ä½œåœºåˆ')">
            <span class="icon">ğŸ’¼</span><span class="text">å·¥ä½œåœºåˆ</span>
        </div>
        <div class="scene-entry" onclick="showActions('æ—…è¡Œè¿œè¶³')">
            <span class="icon">âœˆï¸</span><span class="text">æ—…è¡Œè¿œè¶³</span>
        </div>
    </div>

    <div id="page-2" class="hidden">
        <div class="back-btn" onclick="toPage(1)">â† è¿”å›ä¸»é¡µ</div>
        <h2 id="scene-title"></h2>
        <div id="action-container" class="action-list"></div>
    </div>

    <div id="page-3" class="hidden">
        <div class="back-btn" onclick="toPage(2)">â† è¿”å›åˆ—è¡¨</div>
        <div id="result-list"></div>
    </div>
</div>

<script>
    var API_KEY = 'sk-7d63bfe034c8430eb76bac0f9e00ce5b';
    var API_URL = 'https://api.deepseek.com/chat/completions';
    var currentAudio = null;

    function toPage(num) {
        document.getElementById('page-1').style.display = (num === 1 ? 'block' : 'none');
        document.getElementById('page-2').style.display = (num === 2 ? 'block' : 'none');
        document.getElementById('page-3').style.display = (num === 3 ? 'block' : 'none');
    }

    function showActions(scene) {
        var SCENE_DATA = {
            'æ—¥å¸¸ç”Ÿæ´»': ['èµ·åºŠ', 'æ¢³å¤´', 'ç©¿è¡£æœ', 'åˆ·ç‰™', 'æ´—è„¸', 'åŒ–å¦†', 'æ´—æ¾¡', 'åšé¥­', 'æ•£æ­¥', 'ç¡è§‰'],
            'å·¥ä½œåœºåˆ': ['å¼€ä¼š', 'å‡ºå·®', 'å†™é‚®ä»¶', 'æ‰“ç”µè¯', 'æ±‡æŠ¥', 'åŠ ç­', 'é¢è¯•', 'è¯·å‡', 'æ¥å¾…', 'è¾èŒ'],
            'æ—…è¡Œè¿œè¶³': ['ç™»æœº', 'åè½¦', 'é‡é¤', 'èµèŠ±', 'æ‹ç…§', 'é¢„è®¢', 'é—®è·¯', 'è´­ç‰©', 'æ¢é’±', 'é€€æˆ¿']
        };
        var container = document.getElementById('action-container');
        document.getElementById('scene-title').innerText = scene;
        container.innerHTML = '';
        var items = SCENE_DATA[scene];
        for (var i = 0; i < items.length; i++) {
            (function(act){
                var div = document.createElement('div');
                div.className = 'action-item';
                div.innerHTML = '<span>' + act + '</span><span>â†’</span>';
                div.onclick = function() { doActionSearch(act); };
                container.appendChild(div);
            })(items[i]);
        }
        toPage(2);
    }

    async function doActionSearch(manualWord) {
        var word = manualWord || document.getElementById('keywordInput').value.trim();
        if(!word) return;
        toPage(3);
        var list = document.getElementById('result-list');
        list.innerHTML = '<div style="text-align:center; padding:50px; color:#8e8e93;">AI æ­£åœ¨åˆ†æåœ°é“æ­é…...</div>';

        try {
            var res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + API_KEY },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        {role: "system", content: "è¿”å›5ä¸ªæ—¥è¯­çŸ­è¯­JSONæ•°ç»„:[{\"jp\":\"<ruby>æ±‰<rt>ã‹ã‚“</rt></ruby>\",\"zh\":\"ç¿»è¯‘\"}]"},
                        {role: "user", content: word}
                    ]
                })
            });
            var data = await res.json();
            var phrases = JSON.parse(data.choices[0].message.content.replace(/```json|```/g, ''));
            list.innerHTML = '';
            phrases.forEach(function(p) {
                var card = document.createElement('div');
                card.className = 'phrase-card';
                card.innerHTML = '<div><div style="font-size:18px; font-weight:600;">'+p.jp+'</div><div style="color:#888;">'+p.zh+'</div></div><div style="color:#ff5bec; font-size:24px;">â–¶</div>';
                
                var t = document.createElement('div');
                t.innerHTML = p.jp;
                var rts = t.querySelectorAll('rt');
                for (var j = 0; j < rts.length; j++) { rts[j].parentNode.removeChild(rts[j]); }
                var cleanText = t.innerText || t.textContent;
                
                card.onclick = function() { speak(cleanText); };
                list.appendChild(card);
            });
        } catch (e) {
            list.innerHTML = '<div style="padding:20px; color:red;">è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨ååˆ·æ–°é‡è¯•ã€‚</div>';
        }
    }

    function speak(text) {
        if (currentAudio) { currentAudio.pause(); }
        var url = 'https://fanyi.baidu.com/getvoice?lan=jp&pydown=0&tpl=6&text=' + encodeURIComponent(text);
        currentAudio = new Audio(url);
        currentAudio.play().cat        }
        .phrase-card div:last-child { cursor: pointer !important; user-select: none; }
        .back-btn { color: var(--primary); cursor: pointer; font-size: 14px; margin-bottom: 20px; display: inline-block; font-weight: 600; }
        .hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .error-msg { color: #FF3B30; background: #FFF2F2; padding: 15px; border-radius: 10px; font-size: 14px; margin-top: 20px; line-height: 1.4; }
    </style>
</head>
<body>

<div class="app-container">
    <h1 style="text-align:center; font-size:26px; margin-bottom:40px;">æ—¥è¯­<span style="color:var(--primary)">æ­é…</span>è”æƒ³å®¶</h1>
    <div class="search-box">
        <input type="text" id="keywordInput" placeholder="è¾“å…¥å…³é”®è¯ï¼Œå¦‚ï¼šæ­¯ã€ä¼šè­°..." onkeypress="if(event.keyCode==13) doActionSearch()">
        <button class="search-btn" onclick="doActionSearch()">è”æƒ³</button>
    </div>
    <div id="page-1">
        <div class="scene-entry" onclick="showActions('æ—¥å¸¸ç”Ÿæ´»')">
            <span class="icon">ğŸ </span><span class="text">æ—¥å¸¸ç”Ÿæ´»</span>
        </div>
        <div class="scene-entry" onclick="showActions('å·¥ä½œåœºåˆ')">
            <span class="icon">ğŸ’¼</span><span class="text">å·¥ä½œåœºåˆ</span>
        </div>
        <div class="scene-entry" onclick="showActions('æ—…è¡Œè¿œè¶³')">
            <span class="icon">âœˆï¸</span><span class="text">æ—…è¡Œè¿œè¶³</span>
        </div>
    </div>
    <div id="page-2" class="hidden">
        <span class="back-btn" onclick="toPage(1)">â† è¿”å›ä¸»é¡µ</span>
        <h2 id="scene-title" style="margin-bottom:20px;"></h2>
        <div id="action-container" class="action-list"></div>
    </div>
    <div id="page-3" class="hidden">
        <span class="back-btn" onclick="toPage(2)">â† è¿”å›åˆ—è¡¨</span>
        <div id="result-list"></div>
    </div>
</div>

<script>
    const API_KEY = 'sk-7d63bfe034c8430eb76bac0f9e00ce5b';
    const API_URL = 'https://api.deepseek.com/chat/completions';
    window.currentAudio = null;

    const SCENE_DATA = {
        'æ—¥å¸¸ç”Ÿæ´»': ['èµ·åºŠ', 'æ¢³å¤´', 'ç©¿è¡£æœ', 'åˆ·ç‰™', 'æ´—è„¸', 'åŒ–å¦†', 'æ´—æ¾¡', 'åšé¥­', 'æ•£æ­¥', 'ç¡è§‰'],
        'å·¥ä½œåœºåˆ': ['å¼€ä¼š', 'å‡ºå·®', 'å†™é‚®ä»¶', 'æ‰“ç”µè¯', 'æ±‡æŠ¥', 'åŠ ç­', 'é¢è¯•', 'è¯·å‡', 'æ¥å¾…', 'è¾èŒ'],
        'æ—…è¡Œè¿œè¶³': ['ç™»æœº', 'åè½¦', 'é‡é¤', 'èµèŠ±', 'æ‹ç…§', 'é¢„è®¢', 'é—®è·¯', 'è´­ç‰©', 'æ¢é’±', 'é€€æˆ¿']
    };

    function toPage(num) {
        document.querySelectorAll('[id^="page-"]').forEach(p => p.classList.add('hidden'));
        const target = document.getElementById(`page-${num}`);
        if(target) target.classList.remove('hidden');
    }

    function showActions(scene) {
        const container = document.getElementById('action-container');
        const title = document.getElementById('scene-title');
        if(!container || !title) return;
        title.innerText = scene;
        container.innerHTML = '';
        SCENE_DATA[scene].forEach(act => {
            const div = document.createElement('div');
            div.className = 'action-item';
            div.innerHTML = `<span>${act}</span><span>â†’</span>`;
            div.onclick = () => doActionSearch(act);
            container.appendChild(div);
        });
        toPage(2);
    }

    async function doActionSearch(manualWord = null) {
        const word = manualWord || document.getElementById('keywordInput').value.trim();
        if(!word) return;
        toPage(3);
        const list = document.getElementById('result-list');
        list.innerHTML = '<div style="text-align:center; padding:50px; color:#8e8e93;">AI æ­£åœ¨åˆ†æåœ°é“æ­é…...</div>';
        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        {role: "system", content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ—¥è¯­è€å¸ˆã€‚è¿”å›5ä¸ªæœ€åœ°é“çš„çŸ­è¯­æ­é…ï¼ˆå«åŠ©è¯ï¼‰ã€‚è¦æ±‚ï¼š1.æ±‰å­—å¿…é¡»ä½¿ç”¨HTMLçš„rubyæ ‡ç­¾æ ‡æ³¨å¹³å‡åã€‚2.ä¸¥æ ¼æŒ‰JSONæ•°ç»„æ ¼å¼è¿”å›ï¼š[{\"jp\":\"<ruby>æ±‰<rt>ã‹ã‚“</rt>å­—<rt>ã˜</rt></ruby>\",\"zh\":\"ç¿»è¯‘\"}]ã€‚"}, 
                        {role: "user", content: word}
                    ]
                })
            });
            const data = await res.json();
            const content = data.choices[0].message.content.replace(/```json|```/g, '');
            const phrases = JSON.parse(content);
            list.innerHTML = '';
            phrases.forEach(p => {
                const card = document.createElement('div');
                card.className = 'phrase-card';
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = p.jp;
                const rts = tempDiv.querySelectorAll('rt');
                rts.forEach(rt => rt.remove());
                const pureText = tempDiv.innerText || tempDiv.textContent;
                card.onclick = () => speak(pureText);
                card.innerHTML = `<div><div style="font-size:20px; font-weight:600; line-height:1.8;">${Â  Â  Â  Â  Â  Â  background: white; padding: 18px 25px; border-radius: 15px; 
Â  Â  Â  Â  Â  Â  font-size: 16px; font-weight: 500; cursor: pointer; display: flex; justify-content: space-between;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* ç»“æœå¡ç‰‡ */
Â  Â  Â  Â  /* è§£å†³æ’­æ”¾å›¾æ ‡é¼ æ ‡æ˜¾ç¤ºä¸ºå·¥å­—å‹çš„é—®é¢˜ */
.phrase-card div:last-child {
Â  Â  cursor: pointer !important; Â /* å¼ºåˆ¶å˜å›å°æ‰‹ */
Â  Â  user-select: none; Â  Â  Â  Â  Â  /* é˜²æ­¢ç‚¹å‡»æ—¶é€‰ä¸­ç¬¦å· */
}
        .phrase-card { 
            background: white; padding: 20px; border-radius: 20px; margin-bottom: 12px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); animation: fadeIn 0.4s ease;
        }

        .back-btn { color: var(--primary); cursor: pointer; font-size: 14px; margin-bottom: 20px; display: inline-block; font-weight: 600; }
        .hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .error-msg { color: #FF3B30; background: #FFF2F2; padding: 15px; border-radius: 10px; font-size: 14px; margin-top: 20px; line-height: 1.4; }
    </style>
</head>
<body>

<div class="app-container">
    <h1 style="text-align:center; font-size:26px; margin-bottom:40px;">æ—¥è¯­<span style="color:var(--primary)">æ­é…</span>è”æƒ³å®¶</h1>

    <div class="search-box">
        <input type="text" id="keywordInput" placeholder="è¾“å…¥å…³é”®è¯ï¼Œå¦‚ï¼šæ­¯ã€ä¼šè­°..." onkeypress="if(event.keyCode==13) doActionSearch()">
        <button class="search-btn" onclick="doActionSearch()">è”æƒ³</button>
    </div>

    <div id="page-1">
        <div class="scene-entry" onclick="showActions('æ—¥å¸¸ç”Ÿæ´»')">
            <span class="icon">ğŸ </span><span class="text">æ—¥å¸¸ç”Ÿæ´»</span>
        </div>
        <div class="scene-entry" onclick="showActions('å·¥ä½œåœºåˆ')">
            <span class="icon">ğŸ’¼</span><span class="text">å·¥ä½œåœºåˆ</span>
        </div>
        <div class="scene-entry" onclick="showActions('æ—…è¡Œè¿œè¶³')">
            <span class="icon">âœˆ</span><span class="text">æ—…è¡Œè¿œè¶³</span>
        </div>
    </div>

    <div id="page-2" class="hidden">
        <span class="back-btn" onclick="toPage(1)">â† è¿”å›ä¸»é¡µ</span>
        <h2 id="scene-title" style="margin-bottom:20px;"></h2>
        <div id="action-container" class="action-list"></div>
    </div>

    <div id="page-3" class="hidden">
        <span class="back-btn" onclick="toPage(2)">â† è¿”å›åˆ—è¡¨</span>
        <div id="result-list"></div>
    </div>
</div>

<script>
    const API_KEY = 'sk-7d63bfe034c8430eb76bac0f9e00ce5b'; // è¯·åŠ¡å¿…æ£€æŸ¥Keyæ˜¯å¦æ­£ç¡®
    const API_URL = 'https://api.deepseek.com/chat/completions';

    const SCENE_DATA = {
        'æ—¥å¸¸ç”Ÿæ´»': ['èµ·åºŠ', 'æ¢³å¤´', 'ç©¿è¡£æœ', 'åˆ·ç‰™', 'æ´—è„¸', 'åŒ–å¦†', 'æ´—æ¾¡', 'åšé¥­', 'æ•£æ­¥', 'ç¡è§‰'],
        'å·¥ä½œåœºåˆ': ['å¼€ä¼š', 'å‡ºå·®', 'å†™é‚®ä»¶', 'æ‰“ç”µè¯', 'æ±‡æŠ¥', 'åŠ ç­', 'é¢è¯•', 'è¯·å‡', 'æ¥å¾…', 'è¾èŒ'],
        'æ—…è¡Œè¿œè¶³': ['ç™»æœº', 'åè½¦', 'é‡é¤', 'èµèŠ±', 'æ‹ç…§', 'é¢„è®¢', 'é—®è·¯', 'è´­ç‰©', 'æ¢é’±', 'é€€æˆ¿']
    };

    function toPage(num) {
        document.querySelectorAll('[id^="page-"]').forEach(p => p.classList.add('hidden'));
        document.getElementById(`page-${num}`).classList.remove('hidden');
    }

    function showActions(scene) {
        const container = document.getElementById('action-container');
        document.getElementById('scene-title').innerText = scene;
        container.innerHTML = '';
        SCENE_DATA[scene].forEach(act => {
            const div = document.createElement('div');
            div.className = 'action-item';
            div.innerHTML = `<span>${act}</span><span>â†’</span>`;
            div.onclick = () => doActionSearch(act);
            container.appendChild(div);
        });
        toPage(2);
    }

        async function doActionSearch(manualWord = null) {
        const word = manualWord || document.getElementById('keywordInput').value.trim();
        if(!word) return;

        toPage(3);
        const list = document.getElementById('result-list');
        list.innerHTML = '<div style="text-align:center; padding:50px; color:#8e8e93;">AI æ­£åœ¨åˆ†æåœ°é“æ­é…...</div>';

        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        {
                            role: "system", 
                            // æ ¸å¿ƒä¿®æ”¹ï¼šå¼ºåˆ¶ AI è¿”å›å¸¦ ruby æ ‡ç­¾çš„å†…å®¹
                            content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ—¥è¯­è€å¸ˆã€‚è¿”å›5ä¸ªæœ€åœ°é“çš„çŸ­è¯­æ­é…ï¼ˆå«åŠ©è¯ï¼‰ã€‚è¦æ±‚ï¼š1.æ±‰å­—å¿…é¡»ä½¿ç”¨HTMLçš„rubyæ ‡ç­¾æ ‡æ³¨å¹³å‡åã€‚2.ä¸¥æ ¼æŒ‰JSONæ•°ç»„æ ¼å¼è¿”å›ï¼š[{\"jp\":\"<ruby>æ±‰<rt>ã‹ã‚“</rt>å­—<rt>ã˜</rt></ruby>\",\"zh\":\"ç¿»è¯‘\"}]ã€‚"
                        }, 
                        {role: "user", content: word}
                    ]
                })
            });

            if (res.status === 401) {
                list.innerHTML = `<div class="error-msg">âš  <strong>API Key é”™è¯¯ (401)</strong><br>è¯·æ£€æŸ¥ Key æ˜¯å¦æœ‰æ•ˆã€‚</div>`;
                return;
            }

            const data = await res.json();
            // è¿™é‡Œè·å–çš„å†…å®¹å·²ç»è‡ªå¸¦ <ruby> æ ‡ç­¾äº†
            const phrases = JSON.parse(data.choices[0].message.content);
            
            list.innerHTML = '';
            phrases.forEach(p => {
    const card = document.createElement('div');
    card.className = 'phrase-card';
    
    // ã€ä¿®æ”¹ç‚¹ 1ã€‘ï¼šè¿™é‡Œæ˜¯æ ¸å¿ƒï¼
    // é€»è¾‘ï¼šå…ˆæŠŠ <rt>å‡å</rt> å…¨éƒ¨åˆ æ‰ï¼Œå†æŠŠå‰©ä¸‹çš„ <ruby> ç­‰æ ‡ç­¾åˆ æ‰
    // è¿™æ ·å°±åªå‰©ä¸‹äº†ï¼šæ±‰å­— + åŠ©è¯
    const pureText = p.jp.replace(/<rt>.*?<\/rt>/g, '').replace(/<[^>]+>/g, '');
    
    card.onclick = () => speak(pureText);

    card.innerHTML = `
        <div>
            <div style="font-size:20px; font-weight:600; line-height:1.8;">${p.jp}</div>
            <div style="color:#8e8e93; font-size:14px; margin-top:4px;">${p.zh}</div>
        </div>
        <div style="color:var(--primary); cursor:pointer;">â–¶</div>
    `;
    list.appendChild(card);
});
        } catch (e) {
            list.innerHTML = '<div class="error-msg">è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿ AI è¿”å›äº†æ­£ç¡®çš„æ ¼å¼ã€‚</div>';
        }
    }

    function speak(text) {
    // 1. å½»åº•é”€æ¯æ—§éŸ³é¢‘ï¼Œé˜²æ­¢å®‰å“æµè§ˆå™¨â€œå¡æ­»â€
    if (window.currentAudio) {
        window.currentAudio.pause();
        window.currentAudio.src = "";
        window.currentAudio.load();
    }

    // 2. æå–çº¯å‡€æ—¥è¯­æ–‡æœ¬ï¼ˆå»æ‰ ruby æ³¨éŸ³ï¼‰
    let div = document.createElement("div");
    div.innerHTML = text;
    const rts = div.querySelectorAll('rt');
    rts.forEach(rt => rt.remove());
    let pureText = div.innerText || div.textContent;
    
    // æ¸…æ´—ï¼šå»æ‰ç©ºæ ¼ã€å›è½¦ï¼Œé™åˆ¶é•¿åº¦é˜²æŠ¥é”™
    pureText = pureText.replace(/\s+/g, "").trim().substring(0, 200);
    if (!pureText) return;

    // 3. å‡†å¤‡ä¸¤ä¸ªäº‘ç«¯æ¥å£
    const baiduUrl = `https://fanyi.baidu.com/getvoice?lan=jp&pydown=0&tpl=6&text=${encodeURIComponent(pureText)}`;
    const youdaoUrl = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(pureText)}&le=jap`;

    const audio = new Audio();
    window.currentAudio = audio;

    // --- ç­–ç•¥å¼€å§‹ ---
    
    // ç¬¬ä¸€æ­¥ï¼šå°è¯•ç™¾åº¦
    audio.src = baiduUrl;
    audio.play().catch(() => {
        console.warn("ç™¾åº¦æ¥å£å¤±è´¥ï¼Œå°è¯•æœ‰é“...");
        
        // ç¬¬äºŒæ­¥ï¼šå°è¯•æœ‰é“
        audio.src = youdaoUrl;
        audio.play().catch(() => {
            console.warn("äº‘ç«¯æ¥å£å…¨éƒ¨å¤±æ•ˆï¼Œå¯åŠ¨æœ¬åœ°å…œåº•...");
            
            // ç¬¬ä¸‰æ­¥ï¼šæœ¬åœ°å…œåº•ï¼ˆå¼ºåˆ¶æŒ‡å®šæ—¥è¯­ï¼‰
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(pureText);
            msg.lang = 'ja-JP'; // å¼ºåˆ¶è¦æ±‚æ—¥è¯­ç¯å¢ƒ
            
            // å°è¯•åœ¨æœ¬åœ°è¯­éŸ³åŒ…é‡Œæ‰¾æ—¥è¯­æ’­éŸ³å‘˜
            const voices = window.speechSynthesis.getVoices();
            const jaVoice = voices.find(v => v.lang.includes('ja') || v.name.includes('Japanese'));
            if (jaVoice) msg.voice = jaVoice;
            
            window.speechSynthesis.speak(msg);
        });
    });
}
</script>
</body>
</html>


